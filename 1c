&НаКлиенте
Процедура SendIm(Команда, УИН = "", Токен = "", ТекстСообщения = "")
	
	Если УИН = "" Тогда
		УИН = УИНАдресата;
	КонецЕсли;
	Если Токен="" Тогда
		Токен = ТокенБота;
	КонецЕсли;
	Если ТекстСообщения="" Тогда
		ТекстСообщения = Сообщение;
	КонецЕсли;
	
	
	ТелоЗапроса = Новый Соответствие();
	ТелоЗапроса.Вставить("r",Строка(Новый УникальныйИдентификатор()));
	ТелоЗапроса.Вставить("t",УИН);
	ТелоЗапроса.Вставить("aimsid",Токен);
	ТелоЗапроса.Вставить("message",ТекстСообщения);

	ЗаголовкиЗапроса = Новый Соответствие();
	Запрос = Новый HTTPЗапрос("/im/sendIM"+УпаковатьПараметры(ТелоЗапроса), ЗаголовкиЗапроса);
///////////////	
	ssl = Новый ЗащищенноеСоединениеOpenSSL(
                Новый СертификатКлиентаWindows(
                                СпособВыбораСертификатаWindows.Выбирать),
                Новый СертификатыУдостоверяющихЦентровWindows());   
	
	Соединение = Новый HTTPСоединение("botapi.icq.net", ,,,,,ssl);
	/////////////////
	
	Ответ = Соединение.ОтправитьДляОбработки(Запрос);
КонецПроцедуры


&НаКлиентеНаСервереБезКонтекста
Функция УпаковатьПараметры(Соотв)
	
	к = 0;
	Рез = "";
	Для Каждого ст из Соотв Цикл
		к = к + 1;
		Рез = Рез + ?(к>1,"&","?") + ст.Ключ + "=" + ст.Значение;
	КонецЦикла;
	
	Возврат Рез;
	
КонецФункции

&НаКлиенте
Процедура SendFile(Команда, УИН = "", Токен = "")
	// Вставить содержимое обработчика.
	
	Если УИН = "" Тогда
		УИН = УИНАдресата;
	КонецЕсли;
	Если Токен="" Тогда
		Токен = ТокенБота;
	КонецЕсли;

	
	Режим = РежимДиалогаВыбораФайла.Открытие;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.ПолноеИмяФайла = "";
	
	ДиалогОткрытияФайла.МножественныйВыбор = Истина;
	ДиалогОткрытияФайла.Заголовок = "Выберите файлы";
	Если ДиалогОткрытияФайла.Выбрать() Тогда
		/////////
		ssl = Новый ЗащищенноеСоединениеOpenSSL(
		Новый СертификатКлиентаWindows(
		СпособВыбораСертификатаWindows.Выбирать),
		Новый СертификатыУдостоверяющихЦентровWindows());   
		
		Соединение = Новый HTTPСоединение("botapi.icq.net", ,,,,,ssl);
		
		ПараметрыЗапроса = Новый Соответствие();
		
		ПараметрыЗапроса.Вставить("aimsid",Токен);
		ПараметрыЗапроса.Вставить("filename","");
		
		
		ЗаголовкиЗапроса = Новый Соответствие();
		
		
		////////////
		МассивФайлов = ДиалогОткрытияФайла.ВыбранныеФайлы;
		Для Каждого ИмяФайла Из МассивФайлов Цикл
			ВыбФайл = Новый Файл(ИмяФайла);
			крИмяФайла = ВыбФайл.Имя;
			ПараметрыЗапроса.Вставить("filename", крИмяФайла);
			Запрос = Новый HTTPЗапрос("/im/sendFile"+УпаковатьПараметры(ПараметрыЗапроса), ЗаголовкиЗапроса);
			Запрос.УстановитьИмяФайлаТела(ИмяФайла);
			
			Ответ = Соединение.ОтправитьДляОбработки(Запрос);
			
			ТелоОтвета = Ответ.ПолучитьТелоКакСтроку();
			
			Тело = Новый ЧтениеJSON();
			Тело.УстановитьСтроку(ТелоОтвета);
			ТелоСтр = ПрочитатьJSON(Тело);
						
			УРЛ = ТелоСтр.data.static_url;
			
			SendIm(Команда, УИН, Токен, УРЛ);
			
		КонецЦикла;
	Иначе
		Предупреждение(НСтр("ru = 'Файл(ы) не выбран!'; en = 'File(s) not selected!'"));
	КонецЕсли;
	
	
	
	/////////////////
	
			
///////////////	
		/////////////////
	
	
	
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Вставить содержимое обработчика
	ТокенБота = "<Токен бота>";
	УИНАдресата = "<UIN по умолчанию кому посылаем>";
	
КонецПроцедуры


